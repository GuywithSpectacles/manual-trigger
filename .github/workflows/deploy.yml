name: üöÄ Deploy PHP Projects to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout Code
        uses: actions/checkout@v3

      - name: üîê Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MAC_HOSTINGER_VPS }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -4 ${{ vars.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: üìÇ Sync Project Files
        run: |
          for folder in apps/*/; do
            if [ -d "$folder" ] && [ -f "$folder/index.php" ]; then
              NAME=$(basename "$folder")
              echo "üöö Deploying $NAME..."
              rsync -avz --delete \
                -e "ssh -4 -i ~/.ssh/id_ed25519" \
                "$folder"/ aqeel@31.97.69.91:/home/aqeel/"$NAME"
            else
              echo "‚è≠ Skipped $folder (not a valid PHP project)"
            fi
          done

      - name: ‚öôÔ∏è Configure Nginx and Databases Remotely
        run: |
          ssh -4 -i ~/.ssh/id_ed25519 aqeel@31.97.69.91 bash -s <<'EOF'
            whoami
            BASE_DIR="/home/aqeel"
            PORTS_FILE="$BASE_DIR/ports.txt"
            START_PORT=8081
            BACKUP_DIR="$BASE_DIR/backups"
            mkdir -p "$BACKUP_DIR"
            cd "$BASE_DIR" || exit 1

            # Remove only project-related Nginx configs
            for conf in /etc/nginx/sites-available/*; do
              name=$(basename "$conf")
              [ -d "$BASE_DIR/$name" ] && sudo -n rm -f "$conf"
            done
            for conf in /etc/nginx/sites-enabled/*; do
              name=$(basename "$conf")
              [ -d "$BASE_DIR/$name" ] && sudo -n rm -f "$conf"
            done

            for dir in */; do
              SITE_NAME="${dir%/}"
              # Skip non-project directories
              case "$SITE_NAME" in
                backups|.backup|.ssh|.git|node_modules|.cache|logs|tmp|.*)
                  echo "‚è© Skipped $SITE_NAME (non-project directory)"
                  continue
                  ;;
              esac

              DEPLOY_DIR="$BASE_DIR/$SITE_NAME"
              if [ ! -f "$DEPLOY_DIR/index.php" ]; then
                echo "‚è© Skipped $SITE_NAME (no index.php)"
                continue
              fi

              CONFIG_FILE="/etc/nginx/sites-available/$SITE_NAME"
              ENABLED_LINK="/etc/nginx/sites-enabled/$SITE_NAME"
              DB_NAME="${SITE_NAME}_db"
              DB_USER="${SITE_NAME}_user"
              DB_PASS=$(openssl rand -base64 20 | tr -dc 'a-zA-Z0-9')

              echo "üîß Setting up site: $SITE_NAME"

              # Database setup
              if [ -d "$DEPLOY_DIR" ]; then
                DB_EXISTS=$(sudo -n mysql -uroot -e "SELECT SCHEMA_NAME FROM information_schema.SCHEMATA WHERE SCHEMA_NAME='$DB_NAME';" | grep -w "$DB_NAME")
                if [ -z "$DB_EXISTS" ]; then
                  echo "üóÑ Creating database: $DB_NAME"
                  sudo -n mysql -uroot -e "CREATE DATABASE IF NOT EXISTS \`$DB_NAME\`;"
                  sudo -n mysql -uroot -e "CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';"
                  sudo -n mysql -uroot -e "GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$DB_USER'@'localhost';"
                  sudo -n mysql -uroot -e "FLUSH PRIVILEGES;"
                  if [ -f "$DEPLOY_DIR/db.sql" ]; then
                    echo "üì• Applying db.sql for $DB_NAME..."
                    sudo -n mysql -uroot "$DB_NAME" < "$DEPLOY_DIR/db.sql"
                    echo "‚úÖ Schema applied for $DB_NAME"
                  fi
                fi

                # Write config.php securely
                cat <<'EOCONFIGPHP' | sudo -n tee "$DEPLOY_DIR/config.php"
                <?php
                define('DB_HOST', 'localhost');
                define('DB_NAME', '$DB_NAME');
                define('DB_USER_NAME', '$DB_USER');
                define('DB_PASSWORD', '$DB_PASS');
                ?>
                EOCONFIGPHP

                sudo -n chown aqeel:www-data "$DEPLOY_DIR/config.php"
                sudo -n chmod 640 "$DEPLOY_DIR/config.php"
              fi

              # Port assignment
              touch "$PORTS_FILE"
              PORT=$(grep "^$SITE_NAME:" "$PORTS_FILE" | cut -d':' -f2)
              if [ -z "$PORT" ]; then
                LAST_PORT=$(awk -F: '{print $2}' "$PORTS_FILE" | sort -n | tail -1)
                [ -z "$LAST_PORT" ] && LAST_PORT=$((START_PORT - 1))
                PORT=$((LAST_PORT + 1))
                echo "$SITE_NAME:$PORT" >> "$PORTS_FILE"
              fi

              # Backup previous deployment
              if [ -d "$DEPLOY_DIR" ]; then
                TIME=$(date +%Y%m%d%H%M%S)
                cp -r "$DEPLOY_DIR" "$BACKUP_DIR/${SITE_NAME}_$TIME"
                # Clean up backups older than 7 days
                find "$BACKUP_DIR" -type d -mtime +7 -exec rm -rf {} \;
              fi

              # Nginx Configuration
              cat <<EOCONFIG | sudo -n tee "$CONFIG_FILE"
              server {
                  listen $PORT;
                  server_name _;
                  root $DEPLOY_DIR;
                  index index.php;
                  client_max_body_size 100M;

                  location / {
                      try_files \$uri \$uri/ /index.php?\$query_string;
                  }

                  location ~ \.php\$ {
                      include snippets/fastcgi-php.conf;
                      fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
                      include fastcgi_params;
                  }

                  location ~ /\.ht {
                      deny all;
                  }
              }
              EOCONFIG

              sudo -n chown aqeel:www-data "$CONFIG_FILE"
              sudo -n chmod 644 "$CONFIG_FILE"
              sudo -n ln -sf "$CONFIG_FILE" "$ENABLED_LINK"
              echo "üåç $SITE_NAME live at http://31.97.69.91:$PORT"
            done

            # Firewall Rules
            sudo -n ufw allow 22/tcp
            sudo -n ufw allow 80/tcp
            sudo -n ufw allow 443/tcp
            if [ -f "$PORTS_FILE" ]; then
              while IFS=: read -r site port; do
                if [ -n "$port" ]; then
                  sudo -n ufw allow "$port"/tcp
                  echo "üîì Allowed port $port for $site"
                fi
              done < "$PORTS_FILE"
            fi

            sudo -n ufw reload
            sudo -n ufw status
            sudo -n nginx -t || { echo "üö® Nginx config test failed"; exit 1; }
            sudo -n systemctl reload nginx || { echo "üö® Nginx reload failed"; exit 1; }
            echo "‚úÖ Nginx configured and reloaded successfully"
          EOF

      - name: üêõ Debug SSH
        run: |
          ssh -4 -i ~/.ssh/id_ed25519 aqeel@31.97.69.91 "echo '‚úÖ SSH Working ‚Äî Deployment Complete'"
